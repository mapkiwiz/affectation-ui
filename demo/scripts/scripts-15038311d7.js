"use strict";angular.module("ihmApp",["ngAnimate","ngAria","ngCookies","ngMessages","ngResource","ngRoute","ngSanitize","ngTouch","ui.bootstrap"]).config(["$routeProvider","$locationProvider",function(e,t){e.when("/",{templateUrl:"views/main.html",controller:"EnqueteurPanelCtrl",controllerAs:"main"}).when("/list",{templateUrl:"views/lists.html",controller:"ListCtrl",controllerAs:"list"}).when("/import",{templateUrl:"views/import.html",controller:"ImportCtrl",controllerAs:"import"}).when("/help",{templateUrl:"views/help.html"}).when("/assign",{templateUrl:"views/assign.html",controller:"AssignCtrl",controllerAs:"assign"}).otherwise({redirectTo:"/"}),t.html5Mode(!0)}]),angular.module("ihmApp").controller("MainCtrl",["$scope","$window","UnitesService",function(e,t,r){e.exportCSV=function(){var e=r.entities().features,n=["task,group,worker,lon,lat\n"];angular.forEach(e,function(e){var t=[e.properties.gid,0,e.properties.enqueteur,e.properties.lon,e.properties.lat];n.push(t.join(",")+"\n")});var o=new Blob(n,{type:"text/csv;charset=utf-8;"}),i="affectations.csv";if(t.navigator.msSaveOrOpenBlob)t.navigator.msSaveBlob(o,i);else{var a=t.document,s=a.createElement("a");s.href=t.URL.createObjectURL(o),s.download=i,a.body.appendChild(s),s.click(),a.body.removeChild(s)}}}]),angular.module("ihmApp").controller("EnqueteurPanelCtrl",["$scope","EnqueteursService","UnitesService",function(e,t,r){e.update=function(){e.unites=[];var t=r.entities();if(e.selected&&t)for(var n in t.features){var o=t.features[n];o.properties.enqueteur===e.selected.properties.gid&&e.unites.push(o)}},e.$watch(function(){return t.selectionId},function(r){r&&(e.selected=t.selected(),e.update())})}]),angular.module("ihmApp").controller("ListCtrl",["$rootScope","$scope","EnqueteursService",function(e,t,r){t.selectItem=function(t){e.$broadcast("enqueteur.selected",t.properties.gid,!0),t.properties.marker.bounce({duration:1500,height:120})},t.$watch(r.entities,function(e){e&&(t.enqueteurs=e.features)}),t.$watch(function(){return r.selectionId},function(e){t.selected=e})}]),angular.module("ihmApp").factory("MapContext",["$window",function(e){var t=e.L.map("map"),r={},n={lat:45.5,lng:6,zoom:9},o={toner:{layer:e.L.tileLayer("//stamen-tiles-{s}.a.ssl.fastly.net/toner/{z}/{x}/{y}.png"),label:"Stamen Toner"},lite:{layer:e.L.tileLayer("//stamen-tiles-{s}.a.ssl.fastly.net/toner-lite/{z}/{x}/{y}.png"),label:"Stamen Toner Lite"},osm:{layer:e.L.tileLayer("//{s}.tile.openstreetmap.org/{z}/{x}/{y}.png"),label:"Open Street Map"}};return{basemap:o.lite,getMap:function(){return t},setOverlay:function(e,t){r[e]=t},getOverlay:function(e){return r[e]},getBounds:function(){var e=null;for(var t in r)e?e.extend(r[t].getBounds()):e=r[t].getBounds();return e},getView:function(){return n},getBaseMaps:function(){return o},setBaseMap:function(e){t.removeLayer(this.basemap.layer),e.layer.addTo(t),this.basemap=e},fitAll:function(){var e=this.getBounds();e&&t.fitBounds(e)}}}]).controller("MapCtrl",["$rootScope","$scope","$window","MapContext",function(e,t,r,n){var o=n.getMap();e.mapcontext=n,t.title="TestTitle",t.fitAll=function(){n.fitAll()},t.init=function(){t.mapcontext=n,t.basemaps=n.getBaseMaps(),t.basemap=t.basemaps.lite,t.basemaps.lite.layer.addTo(o);var e=n.getView();o.setView(r.L.latLng(e.lat,e.lng),e.zoom,!0)},t.$on("map.data.loaded",function(){n.fitAll()}),t.init()}]),angular.module("ihmApp").directive("fileChange",["$parse",function(e){return{require:"ngModel",restrict:"A",link:function(t,r,n,o){var i=e(n.fileChange),a=function(e){t.$apply(function(){i(t,{$event:e,files:e.target.files})})};r[0].addEventListener("change",a,!1)}}}]).filter("csvToGeojson",function(){var e=function(e,t){if(e){for(var r={},n=0;n<Math.min(e.length,t.length);n++)r[t[n]]=e[n];return r}return null};return function(t){var r=",",n=t.split("\n"),o=n.shift().trim().split(r),i=[];return angular.forEach(n,function(t){var n=e(t.trim().split(r),o);n&&n.task&&i.push({type:"Feature",properties:{gid:parseInt(n.task),group:n.group&&parseInt(n.group)||void 0,enqueteur:n.worker&&parseInt(n.worker)||void 0,lon:parseFloat(n.lon),lat:parseFloat(n.lat)},geometry:{type:"Point",coordinates:[parseFloat(n.lon),parseFloat(n.lat)]}})}),{type:"FeatureCollection",features:i}}}).controller("ImportCtrl",["$scope","$filter","UnitesService",function(e,t,r){e.handler=function(n,o){var i=new FileReader;i.onload=function(n){var o=i.result,a=t("csvToGeojson")(o);r.setEntities(a),e.$apply()},console.log(o[0]),i.readAsText(o[0])}}]),angular.module("ihmApp").factory("DistanceService",["$window",function(e){var t=e.L.latLng;return function(e,r){var n=t(e.coordinates[1],e.coordinates[0]),o=t(r.coordinates[1],r.coordinates[0]);return n.distanceTo(o)}}]).factory("PointInPolygon",[function(){return function(e,t){for(var r=t.coordinates[0].length,n=function(e){return{lon:t.coordinates[0][e][0],lat:t.coordinates[0][e][1]}},o=function(e,t,r){var n=t.lon-e.lon,o=t.lat-e.lat,i=r.lon-e.lon,a=r.lat-e.lat;return n*a-o*i},i={lon:e.coordinates[0],lat:e.coordinates[1]},a=0,s=0;r-1>s;s++){var u=n(s),l=n(s+1);u.lat<=i.lat?l.lat>i.lat&&o(u,l,i)>0&&a++:l.lat<=i.lat&&o(u,l,i)<0&&a--}return 0!==a}}]).service("AssignAlgo",["DistanceService","PointInPolygon",function(e,t){var r=function(){this.minAssignedCapacity=2,this.defaultCapacity=10};return r.prototype.distanceMatrix=function(r,n){var o=[];return angular.forEach(r,function(r){var i=r.properties.isochrone,a=[];angular.forEach(n,function(n){if(i&&t(n.geometry,i)){var o=e(r.geometry,n.geometry);a.push(o)}else a.push(1/0)}),o.push(a)}),o},r.prototype.costMatrix=function(e,t){for(var r=[],n=0;n<e.length;n++){for(var o=[],i=t[n].properties.capacity,a=0;a<e[n].length;a++){var s=this.costNewlyAssigned(e,n,a,i);o.push(s)}r.push(o)}return r},r.prototype.costAlreadyAssigned=function(e,t,r,n){return 0>=n?Math.pow(e[t][r],2)/this.minAssignedCapacity:Math.pow(e[t][r],2)/(1.25*n)},r.prototype.costNewlyAssigned=function(e,t,r,n){return 0>=n?1/0:Math.pow(e[t][r],2)/n},r.prototype.assign=function(e,t,r){var n,o,i=r&&r.defaultCapacity||this.defaultCapacity;for(o=0;o<e.length;o++)e[o].properties.load=0,e[o].properties.capacity=e[o].properties.capacity||i;console.log("Computing distance matrix");var a=this.distanceMatrix(e,t);console.log("Computing cost matrix");var s=this.costMatrix(a,e),u=10,l=0,c=[];for(n=0;n<t.length;n++)c[n]=void 0;for(var p=function(e){return e.properties.capacity-e.properties.load};u>l;){console.log("Iteration "+l);var f,d=0;for(n=0;n<t.length;n++){var g=1/0;for(f=void 0,o=0;o<e.length;o++){var h=s[o][n];g>h&&(g=h,f=o)}if(void 0!==f){var m=c[n];if(f!==m){d++,c[n]=f,e[f].properties.load=e[f].properties.load+1,void 0!==m&&(e[m].properties.load=e[m].properties.load-1);for(var v=0;v<t.length;v++)void 0!==m&&(s[m][v]=this.costNewlyAssigned(a,m,v,p(e[m]))),s[f][v]=this.costAlreadyAssigned(a,f,v,p(e[f]))}}}if(0===d)break;l++}return console.log("Done"),c},r}]).controller("AssignCtrl",["$rootScope","$scope","$q","EnqueteursService","UnitesService","IsochroneService","AssignAlgo",function(e,t,r,n,o,i,a){t.mustConfirmBeforeProcess=!0,t.computeAssignment=function(){var s=n.entities(),u=o.entities(),l=[];angular.forEach(s.features,function(e){l.push(i(e.properties.gid,function(t){e.properties.isochrone=t}))});var c=function(){for(var r=new a,n=r.assign(s.features,u.features),o=0,i=0,l={},c=0;c<u.features.length;c++)if(void 0!==n[c]){var p=s.features[n[c]].properties;u.features[c].properties.enqueteur=p.gid,o++,l[n[c]]=!0}i=Object.keys(l).length,t.assignedTasks=o,t.unassignedTasks=u.features.length-o,t.hiredWorkers=i,t.unusedWorkers=s.features.length-i,t.mustConfirmBeforeProcess=!0,e.$broadcast("assignment.changed")};r.all(l).then(function(){c()})},t.confirmBeforeProcess=function(){t.mustConfirmBeforeProcess=!1},t.cancel=function(){t.mustConfirmBeforeProcess=!0}}]),angular.module("ihmApp").factory("EnqueteursService",["$http","$cacheFactory",function(e,t){var r=null,n=t.get("$http"),o=function(t){return t&&n.removeAll(),e.get("data/enqueteurs.geojson",{cache:!0}).then(function(e){r=e.data})},i=function(e){if(r)for(var t in r.features)if(r.features[t].properties.gid==e)return r.features[t];return void 0};return{selectionId:void 0,getEntities:o,entities:function(){return r},setEntities:function(e){r=e},findEntity:i,selected:function(){return this.selectionId?this.findEntity(this.selectionId):void 0}}}]).controller("EnqueteursLayerCtrl",["$rootScope","$scope","$window","$location","$anchorScroll","MapContext","EnqueteursService","IsochroneService",function(e,t,r,n,o,i,a,s){var u=i.getMap(),l=function(e){t.workerIndex={},angular.forEach(e,function(e){t.workerIndex[e.properties.gid]=e})};t.$watch(a.entities,function(n,o){n&&(t.enqueteurs=n.features,l(n.features),t.layer=r.L.geoJson(n,{onEachFeature:function(r,n){n.on("click",function(n){e.$broadcast("enqueteur.selected",r.properties.gid,!1,!0),t.$apply()}),r.properties.marker=n}}),t.layer.addTo(u),t.$emit("map.data.loaded"),i.setOverlay("enqueteurs",t.layer))}),t.$on("enqueteur.selected",function(e,n,i,l){var c=a.findEntity(n);c&&(a.selectionId=n,i&&u.panTo({lon:c.properties.lon,lat:c.properties.lat}),s(c.properties.gid,function(e){t.isochrone&&u.removeLayer(t.isochrone),t.isochrone=r.L.geoJson(e),t.isochrone.addTo(u)}),l&&o("enqueteur"+n))}),t.$on("task.reassigned",function(e,r){if(r.wasAssignedTo){var n=t.workerIndex[r.wasAssignedTo];n.properties.load=n.properties.load-1}if(r.assignedTo){var n=t.workerIndex[r.assignedTo];n.properties.load=n.properties.load+1}}),this.getLayer=function(){return t.layer},t.init=function(){a.getEntities()},t.init()}]),angular.module("ihmApp").factory("UnitesService",["$http","$cacheFactory",function(e,t){var r=null,n=t.get("$http"),o=function(t){return t&&n.removeAll(),e.get("data/us.geojson",{cache:!0}).then(function(e){r=e.data})};return{getEntities:o,setEntities:function(e){r=e},entities:function(){return r}}}]).controller("UnitesLayerCtrl",["$rootScope","$scope","$window","MapContext","UnitesService",function(e,t,r,n,o){var i=n.getMap();t.status=function(e,t){return t?e.properties.enqueteur?e.properties.enqueteur==t?"us-marker us-marker-selected":"us-marker us-marker-assigned-other":"us-marker us-marker-unassigned":e.properties.enqueteur?"us-marker us-marker-assigned-other":"us-marker us-marker-unassigned"},t.featureToMarker=function(e,n,o){var i=r.L.divIcon({className:t.status(e,o),html:'<span class="glyphicon glyphicon-record"></span>',iconSize:r.L.point(20,20)});return r.L.marker(n,{icon:i})},t.drawLayer=function(o){t.unites&&(t.layer&&i.removeLayer(t.layer),t.layer=r.L.geoJson(t.unites,{pointToLayer:function(e,r){return t.featureToMarker(e,r,o)},onEachFeature:function(r,n){o&&n.on("click",function i(n){if(t.layer.removeLayer(this),r.properties.enqueteur==o)r.properties.enqueteur=void 0,e.$broadcast("task.reassigned",{entity:r,wasAssignedTo:o,assignedTo:void 0});else{var a=r.properties.enqueteur;r.properties.enqueteur=o,e.$broadcast("task.reassigned",{entity:r,wasAssignedTo:a,assignedTo:o})}var s=t.featureToMarker(r,this.getLatLng(),o);s.addTo(t.layer),s.on("click",i),t.$apply()}),r.properties.marker=n}}),t.layer.addTo(i),n.setOverlay("unites",t.layer))},t.$watch(o.entities,function(e,r){e&&(t.unites=e,t.drawLayer(),t.$emit("map.data.loaded"))}),t.$on("enqueteur.selected",function(e,r){t.drawLayer(r)}),t.$on("assignment.changed",function(){t.drawLayer()}),o.getEntities()}]),angular.module("ihmApp").factory("IsochroneService",["$http","$cacheFactory",function(e,t){var r=function(t,r){return e.get("data/isochrones/iso_20m_"+t+".geojson",{cache:!0}).then(function(e){r(e.data)})};return r}]);